#########################################################################
##      _____ __  __ _   ___  __      ____             __ _            ##
##     |_   _|  \/  | | | \ \/ /     / ___|___  _ __  / _(_) __ _      ##
##       | | | |\/| | | | |\  /     | |   / _ \| '_ \| |_| |/ _` |     ## 
##       | | | |  | | |_| |/  \     | |__| (_) | | | |  _| | (_| |     ##
##       |_| |_|  |_|\___//_/\_\     \____\___/|_| |_|_| |_|\__, |     ##
##                                                          |___/      ##  
##                                                                     ##
#########################################################################

### Keybinds
### --------------------------------------------------------

# Make C+Space the tmux prefix
unbind C-Space
set -g prefix C-Space
bind C-Space send-prefix

# Splitting which makes more sense IMO
unbind '"'
bind-key "|" split-window -h -c "#{pane_current_path}"
bind-key "\\" split-window -fh -c "#{pane_current_path}"

unbind '%'
bind-key "-" split-window -v -c "#{pane_current_path}"
bind-key "_" split-window -fv -c "#{pane_current_path}"

# Reload configuration
bind-key r source-file ~/.tmux.conf \; display '~/.tmux.conf reloaded.'

# Kill current pane
bind-key x kill-pane\; refresh-client -S

# Syncronize panes
bind S set-window-option synchronize-panes

# Unbind s which is used by default for "Select a new session for the attached client interactively"
# because it gets in the way of my sync keybind
unbind s

### General config
### --------------------------------------------------------

# Start window numbering at 1
set -g base-index 1     

# Make pane numbering consistent with window
setw -g pane-base-index 1

# Rename window to reflect current program
setw -g automatic-rename on

 # Renumber windows when a window is closed 
set -g renumber-windows on   

# Set terminal title
set -g set-titles on          

# Increase pane indicators display time
set -g display-panes-time 1000 

# Increase status messages display time
set -g display-time 1000     

# Refresh status line every second
set -g status-interval 1    

# Dont rename windows automatically
# Rename manually with C+,
set -g allow-rename off

# Silence everything
set -g bell-action none
set -g monitor-activity off
set -g visual-activity off
set -g monitor-silence 0
set -g visual-silence off

# Keep current directory
bind c new-window -c "#{pane_current_path}"

# Enable mouse
set -g mouse on

# Increase history
set-option -g history-limit 50000

# Faster key repetition
set -s escape-time 50

# Colors!!!
set-option -g default-terminal "screen-256color"

### Custom Status Bar
### --------------------------------------------------------

# #S = Name of session
# #F = Window flags
# #I = Index of window
# #W = Name of window



### Remote config
### --------------------------------------------------------

# Load settings for remote session.
if-shell "test -n '$SSH_CLIENT'" "source-file -q ~/.tmux.conf.remote"

### TPM
### --------------------------------------------------------

# List of plugins
set -g @plugin "tmux-plugins/tpm" # https://github.com/tmux-plugins/tpm
set -g @plugin 'dracula/tmux'
set -g @plugin 'tmux-plugins/tmux-yank'
# set -g @plugin 'wfxr/tmux-power' # https://github.com/wfxr/tmux-power

# Dracula Theme
set -g @dracula-show-powerline true
set -g @dracula-show-left-icon session
set -g @dracula-show-flags true
set -g @dracula-refresh-rate 1
set -g @dracula-border-contrast false
set -g @dracula-day-month true
set -g @dracula-left-icon-padding 0

set -g @dracula-plugins "cpu-usage ram-usage time" # cpu-usage ram-usage time git

# Powerline Theme
# set -g @tmux_power_theme 'gold' # gold, redwine, moon, forest, violet, snow, coral, sky, default = terminal color scheme

# Install TMUX Plugin Manager if it is not installed
if "test ! -d ~/.tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm && ~/.tmux/plugins/tpm/bin/install_plugins'"

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run "~/.tmux/plugins/tpm/tpm"

# Custom change for plugin: tmux-power
# set -gq status-justify left # Move it back to the left

# Original hack for adding content to the right status in dracula
# https://github.com/dracula/tmux/issues/49#issuecomment-955120838 
# set-option -ga status-right "#[fg=#44475a,bg=#ffb86c] #(~/.tmux/plugins/kube-tmux/kube.tmux 250 black black) #[bg=#44475a,fg=#ffb86c] #{?#{!=:#{pane_current_command},ssh},#h,#(ps -t #{pane_tty} -oargs | awk -F@ '/ssh/ { print $2 #}')} "

set-option -ga status-right "\
#[fg=#ffb86c]#[fg=#44475a,bg=#ffb86c] \
#(whoami)@\
#{?\
#{!=:#{pane_current_command},ssh},\
#h,\
#(ps -t \
#{pane_tty} -oargs | awk -F@ '/ssh/ { print $2 \
#}')} "
# explanation for the what the f. is going on.
# #{?                                   // ? is an introduction to tmux's conditionals.
#   #{!=:#{pane_current_command},ssh},  // if #{pane_current_command} is ssh, returns 1, else 0. 
#   #h,                                 // #h is the hostname of the local host
#   #(ps \                              // use ps find the ssh process
#     --tty #{pane_tty}                 // list all processes attached to the pane's tty
#     -oargs \                          // show full cmdline in output
#       | awk \                         // get some awk in here.
#           -F@ \                       // split the cmdline by the '@' of the uri.
#           '/ssh/ { print $2 #}')}     // filter for commands with ssh, and print the hostname

# Check if device has network.
run-shell 'tmux set-environment -g has_network \
    $(if [ "$(ip link show | awk "/^[1-9]{1}:/ && !/DOWN/ && !/NO-CARRIER/ && !/^[1-9]{1}: lo:/ {print $0}" | wc -l)" -eq 1 ]; \
    then echo 1; else echo 0; fi)'

# Add a sync "SYNC ON" indicator to the far right to show if the panes are in sync
set -ag status-right "\
#{?pane_synchronized,\
#[fg=red]#[bg=red]\
#[fg=white] SYNC ON \
#[default],}"

set -ag status-right "#[fg=colour7]#{?has_network,#[bg=red] 轢 ,#[bg=green] 歷 }"
